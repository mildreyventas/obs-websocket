<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üé¨ obs-websocket Test Client</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #333;
            padding: 20px;
            min-height: 100vh;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }

        h1 {
            color: #667eea;
            margin-bottom: 10px;
            font-size: 2.5em;
        }

        .subtitle {
            color: #666;
            margin-bottom: 30px;
            font-size: 1.1em;
        }

        .connection-panel {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
        }

        .status {
            display: inline-block;
            padding: 8px 16px;
            border-radius: 20px;
            font-weight: bold;
            margin-bottom: 15px;
        }

        .status.disconnected {
            background: #ff6b6b;
            color: white;
        }

        .status.connected {
            background: #51cf66;
            color: white;
        }

        .status.connecting {
            background: #ffd43b;
            color: #333;
        }

        .input-group {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 15px;
            margin-bottom: 15px;
        }

        input {
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 14px;
        }

        input:focus {
            outline: none;
            border-color: #667eea;
        }

        button {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        .btn-connect {
            background: #51cf66;
            color: white;
        }

        .btn-disconnect {
            background: #ff6b6b;
            color: white;
        }

        .btn-request {
            background: #667eea;
            color: white;
            margin: 5px;
        }

        .panels {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-top: 20px;
        }

        .panel {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
        }

        .panel h2 {
            color: #667eea;
            margin-bottom: 15px;
            font-size: 1.3em;
        }

        .log {
            background: #1e1e1e;
            color: #d4d4d4;
            padding: 15px;
            border-radius: 8px;
            height: 400px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            line-height: 1.6;
        }

        .log-entry {
            margin-bottom: 8px;
            padding: 5px;
            border-left: 3px solid #667eea;
            padding-left: 10px;
        }

        .log-entry.event {
            border-color: #51cf66;
        }

        .log-entry.error {
            border-color: #ff6b6b;
        }

        .buttons-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
        }

        .clear-btn {
            background: #868e96;
            color: white;
            width: 100%;
            margin-top: 10px;
        }

        @media (max-width: 768px) {
            .input-group, .panels, .buttons-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üé¨ obs-websocket Test Client</h1>
        <p class="subtitle">Cliente de prueba interactivo para obs-websocket</p>

        <div class="connection-panel">
            <div class="status disconnected" id="status">‚≠ï Desconectado</div>

            <div class="input-group">
                <input type="text" id="host" value="psychic-winner-q75599wjg7rqcp57-4455.app.github.dev" placeholder="Host">
                <input type="number" id="port" value="443" placeholder="Puerto">
                <input type="password" id="password" value="supersecretpassword" placeholder="Password">
            </div>

            <button class="btn-connect" id="connectBtn" onclick="connect()">üîå Conectar</button>
            <button class="btn-disconnect" id="disconnectBtn" onclick="disconnect()" style="display:none;">üîå Desconectar</button>
        </div>

        <div class="panels">
            <div class="panel">
                <h2>üì§ Requests Disponibles</h2>
                <div class="buttons-grid">
                    <button class="btn-request" onclick="sendRequest('GetVersion')">GetVersion</button>
                    <button class="btn-request" onclick="sendRequest('GetStats')">GetStats</button>
                    <button class="btn-request" onclick="sendRequest('GetSceneList')">GetSceneList</button>
                    <button class="btn-request" onclick="sendRequest('GetCurrentProgramScene')">Get Scene</button>
                    <button class="btn-request" onclick="setScene()">Set Scene</button>
                    <button class="btn-request" onclick="sendRequest('StartStream')">‚ñ∂Ô∏è Start Stream</button>
                    <button class="btn-request" onclick="sendRequest('StopStream')">‚èπÔ∏è Stop Stream</button>
                    <button class="btn-request" onclick="sendRequest('StartRecord')">üî¥ Start Record</button>
                    <button class="btn-request" onclick="sendRequest('StopRecord')">‚èπÔ∏è Stop Record</button>
                </div>
            </div>

            <div class="panel">
                <h2>üìä Informaci√≥n del Servidor</h2>
                <div id="serverInfo" style="font-family: monospace; font-size: 12px;">
                    <p>No conectado</p>
                </div>
            </div>
        </div>

        <div class="panel" style="margin-top: 20px;">
            <h2>üìã Log de Comunicaci√≥n</h2>
            <div class="log" id="log"></div>
            <button class="clear-btn" onclick="clearLog()">üóëÔ∏è Limpiar Log</button>
        </div>
    </div>

    <script>
        let ws = null;
        let requestId = 0;
        let serverInfo = {};

        function updateStatus(status, text) {
            const statusEl = document.getElementById('status');
            statusEl.className = `status ${status}`;
            statusEl.textContent = text;
        }

        function log(message, type = 'info') {
            const logEl = document.getElementById('log');
            const entry = document.createElement('div');
            entry.className = `log-entry ${type}`;
            entry.innerHTML = `<strong>[${new Date().toLocaleTimeString()}]</strong> ${message}`;
            logEl.appendChild(entry);
            logEl.scrollTop = logEl.scrollHeight;
        }

        function clearLog() {
            document.getElementById('log').innerHTML = '';
        }

        function updateServerInfo(data) {
            const infoEl = document.getElementById('serverInfo');
            infoEl.innerHTML = `
                <p><strong>OBS Version:</strong> ${data.obsVersion || 'N/A'}</p>
                <p><strong>obs-websocket:</strong> ${data.obsWebSocketVersion || 'N/A'}</p>
                <p><strong>RPC Version:</strong> ${data.rpcVersion || 'N/A'}</p>
                <p><strong>Platform:</strong> ${data.platform || 'N/A'}</p>
            `;
        }

        async function sha256(message) {
            const msgBuffer = new TextEncoder().encode(message);
            const hashBuffer = await crypto.subtle.digest('SHA-256', msgBuffer);
            return hashBuffer;
        }

        function arrayBufferToBase64(buffer) {
            let binary = '';
            const bytes = new Uint8Array(buffer);
            bytes.forEach(b => binary += String.fromCharCode(b));
            return btoa(binary);
        }

        async function generateAuthString(password, salt, challenge) {
            // Paso 1: Hash de password + salt
            const secretHash = await sha256(password + salt);
            const secretB64 = arrayBufferToBase64(secretHash);

            // Paso 2: Hash de secretB64 + challenge
            const authHash = await sha256(secretB64 + challenge);
            const authString = arrayBufferToBase64(authHash);

            return authString;
        }

        async function connect() {
            const host = document.getElementById('host').value.trim();
            const port = document.getElementById('port').value.trim();
            const password = document.getElementById('password').value;

            // Usar ws:// para localhost, wss:// para otros hosts
            let protocol;
            let wsUrl;

            if (host === 'localhost' || host === '127.0.0.1') {
                protocol = 'ws:';
                wsUrl = port ? `${protocol}//${host}:${port}` : `${protocol}//${host}`;
            } else if (host.includes('app.github.dev')) {
                // Codespaces ya incluye el puerto en el hostname
                protocol = 'wss:';
                wsUrl = `${protocol}//${host}`;
            } else {
                protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
                wsUrl = port ? `${protocol}//${host}:${port}` : `${protocol}//${host}`;
            }

            updateStatus('connecting', 'üîÑ Conectando...');
            log('üîå Intentando conectar a ' + wsUrl);

            try {
                ws = new WebSocket(wsUrl);

                ws.onopen = () => {
                    log('‚úÖ WebSocket conectado', 'event');
                };

                ws.onmessage = async (event) => {
                    const data = JSON.parse(event.data);
                    log('üì• Recibido: ' + JSON.stringify(data, null, 2));

                    // OpCode 0: Hello
                    if (data.op === 0) {
                        log('üëã Hello recibido del servidor', 'event');

                        const authString = await generateAuthString(
                            password,
                            data.d.authentication.salt,
                            data.d.authentication.challenge
                        );

                        const identify = {
                            op: 1,
                            d: {
                                rpcVersion: data.d.rpcVersion,
                                authentication: authString,
                                eventSubscriptions: 33
                            }
                        };

                        ws.send(JSON.stringify(identify));
                        log('üì§ Identify enviado con autenticaci√≥n', 'event');
                    }

                    // OpCode 2: Identified
                    else if (data.op === 2) {
                        updateStatus('connected', '‚úÖ Conectado');
                        log('‚úÖ Identificado correctamente!', 'event');
                        document.getElementById('connectBtn').style.display = 'none';
                        document.getElementById('disconnectBtn').style.display = 'inline-block';

                        // Obtener info del servidor
                        sendRequest('GetVersion');
                    }

                    // OpCode 5: Event
                    else if (data.op === 5) {
                        log(`üîî Evento: ${data.d.eventType}`, 'event');
                        log('   Datos: ' + JSON.stringify(data.d.eventData, null, 2), 'event');
                    }

                    // OpCode 7: RequestResponse
                    else if (data.op === 7) {
                        log(`‚úÖ Response: ${data.d.requestType}`, 'event');

                        if (data.d.requestType === 'GetVersion') {
                            updateServerInfo(data.d.responseData);
                            serverInfo = data.d.responseData;
                        }

                        if (data.d.responseData) {
                            log('   ' + JSON.stringify(data.d.responseData, null, 2));
                        }
                    }
                };

                ws.onerror = (error) => {
                    log('‚ùå Error de conexi√≥n: ' + error, 'error');
                    updateStatus('disconnected', '‚ùå Error');
                };

                ws.onclose = () => {
                    log('üîå Conexi√≥n cerrada', 'error');
                    updateStatus('disconnected', '‚≠ï Desconectado');
                    document.getElementById('connectBtn').style.display = 'inline-block';
                    document.getElementById('disconnectBtn').style.display = 'none';
                    ws = null;
                };

            } catch (error) {
                log('‚ùå Error: ' + error.message, 'error');
                updateStatus('disconnected', '‚ùå Error');
            }
        }

        function disconnect() {
            if (ws) {
                ws.close();
                log('üîå Desconectando...');
            }
        }

        function sendRequest(requestType, requestData = {}) {
            if (!ws || ws.readyState !== WebSocket.OPEN) {
                log('‚ùå No est√°s conectado', 'error');
                return;
            }

            requestId++;
            const request = {
                op: 6,
                d: {
                    requestType: requestType,
                    requestId: requestId.toString(),
                    requestData: requestData
                }
            };

            ws.send(JSON.stringify(request));
            log(`üì§ Request enviado: ${requestType}`);
        }

        function setScene() {
            const sceneName = prompt('Nombre de la escena:', 'Scene 2');
            if (sceneName) {
                sendRequest('SetCurrentProgramScene', { sceneName: sceneName });
            }
        }
    </script>
</body>
</html>
